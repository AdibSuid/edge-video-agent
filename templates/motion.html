<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motion Settings - Edge Agent</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background: #f5f5f5; }
        .card { margin-bottom: 20px; }
        #zoneCanvas {
            border: 2px solid #ddd;
            background: #f0f0f0;
            cursor: crosshair;
            border-radius: 4px;
        }
        .zone-item {
            padding: 5px;
            margin: 5px 0;
            background: #f8f9fa;
            border-left: 3px solid #28a745;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row mb-4">
            <div class="col">
                <h1><i class="fas fa-cog"></i> Motion Detection Settings</h1>
                <p class="text-muted">Configure motion detection zones and sensitivity</p>
                <a href="/" class="btn btn-secondary btn-sm"><i class="fas fa-arrow-left"></i> Back</a>
            </div>
        </div>

        <div class="row">
            <div class="col-md-7">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Detection Zones</h5>
                        <p class="small text-muted">Click to add zones. Click and drag to move zones. Delete key to remove selected zone.</p>
                        <canvas id="zoneCanvas" width="640" height="360"></canvas>
                        <div class="mt-3">
                            <button onclick="clearZones()" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash"></i> Clear All Zones
                            </button>
                            <button onclick="saveZones()" class="btn btn-sm btn-success">
                                <i class="fas fa-save"></i> Save Zones
                            </button>
                        </div>
                        <div id="zoneList" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-5">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Detection Settings</h5>
                        <form id="motionForm">
                            <div class="mb-3">
                                <label for="sensitivity" class="form-label">
                                    Sensitivity: <span id="sensitivityValue">{{ sensitivity }}</span>
                                </label>
                                <input type="range" class="form-range" id="sensitivity" 
                                       name="sensitivity" min="5" max="50" value="{{ sensitivity }}"
                                       oninput="document.getElementById('sensitivityValue').textContent = this.value">
                                <small class="text-muted">Lower = more sensitive (5-50)</small>
                            </div>

                            <div class="mb-3">
                                <label for="min_area" class="form-label">Minimum Area (pixels)</label>
                                <input type="number" class="form-control" id="min_area" 
                                       name="min_area" value="{{ min_area }}" min="100" max="5000">
                                <small class="text-muted">Minimum motion size to trigger (100-5000)</small>
                            </div>

                            <div class="mb-3">
                                <label for="cooldown" class="form-label">Cooldown (seconds)</label>
                                <input type="number" class="form-control" id="cooldown" 
                                       name="cooldown" value="{{ cooldown }}" min="1" max="60">
                                <small class="text-muted">Time to stay in high FPS after motion stops</small>
                            </div>

                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Settings
                            </button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-info-circle"></i> How It Works</h5>
                        <ul class="small">
                            <li><strong>Idle:</strong> 1 FPS (saves bandwidth)</li>
                            <li><strong>Motion:</strong> 25 FPS (full quality)</li>
                            <li><strong>Zones:</strong> Only detect motion in marked areas</li>
                            <li><strong>Cooldown:</strong> Stay in high FPS after motion</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let zones = {{ zones | tojson }};
        let selectedZone = null;
        const canvas = document.getElementById('zoneCanvas');
        const ctx = canvas.getContext('2d');
        let isDragging = false;
        let dragOffset = {x: 0, y: 0};

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            zones.forEach((z, i) => {
                // Draw zone rectangle
                ctx.strokeStyle = selectedZone === i ? '#007bff' : '#28a745';
                ctx.lineWidth = 3;
                ctx.strokeRect(z[0], z[1], z[2], z[3]);
                
                // Fill with semi-transparent color
                ctx.fillStyle = selectedZone === i ? 'rgba(0, 123, 255, 0.15)' : 'rgba(40, 167, 69, 0.1)';
                ctx.fillRect(z[0], z[1], z[2], z[3]);
                
                // Draw zone number
                ctx.fillStyle = selectedZone === i ? '#007bff' : '#28a745';
                ctx.font = 'bold 14px Arial';
                ctx.fillText(`Zone ${i + 1}`, z[0] + 5, z[1] + 20);
            });
        }

        canvas.addEventListener('mousedown', e => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Check if clicking on existing zone
            selectedZone = zones.findIndex(z =>
                x >= z[0] && x <= z[0] + z[2] && y >= z[1] && y <= z[1] + z[3]
            );
            
            if (selectedZone === -1) {
                // Create new zone
                zones.push([Math.max(0, x - 50), Math.max(0, y - 50), 100, 100]);
                selectedZone = zones.length - 1;
            } else {
                // Start dragging
                const z = zones[selectedZone];
                dragOffset = {x: x - z[0], y: y - z[1]};
                isDragging = true;
            }
            
            draw();
            updateZoneList();
        });

        canvas.addEventListener('mousemove', e => {
            if (isDragging && selectedZone !== null) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left - dragOffset.x;
                const y = e.clientY - rect.top - dragOffset.y;
                
                const z = zones[selectedZone];
                z[0] = Math.max(0, Math.min(canvas.width - z[2], x));
                z[1] = Math.max(0, Math.min(canvas.height - z[3], y));
                
                draw();
            }
        });

        canvas.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                saveZones();
            }
        });

        // Handle delete key
        document.addEventListener('keydown', e => {
            if (e.key === 'Delete' && selectedZone !== null) {
                zones.splice(selectedZone, 1);
                selectedZone = null;
                draw();
                updateZoneList();
                saveZones();
            }
        });

        function clearZones() {
            if (confirm('Clear all zones?')) {
                zones = [];
                selectedZone = null;
                draw();
                updateZoneList();
                saveZones();
            }
        }

        async function saveZones() {
            try {
                const response = await fetch('/api/save_zones', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        zones: zones.map(z => ({x: z[0], y: z[1], w: z[2], h: z[3]}))
                    })
                });

                const data = await response.json();
                if (!data.success) {
                    console.error('Failed to save zones:', data.error);
                }
            } catch (error) {
                console.error('Error saving zones:', error);
            }
        }

        function updateZoneList() {
            const list = document.getElementById('zoneList');
            if (zones.length === 0) {
                list.innerHTML = '<p class="text-muted small">No zones defined. Click on canvas to add.</p>';
            } else {
                list.innerHTML = zones.map((z, i) =>
                    `<div class="zone-item small">
                        <strong>Zone ${i + 1}:</strong> Position (${Math.round(z[0])}, ${Math.round(z[1])}) - Size ${Math.round(z[2])}Ã—${Math.round(z[3])}
                    </div>`
                ).join('');
            }
        }

        document.getElementById('motionForm').onsubmit = async e => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                sensitivity: formData.get('sensitivity'),
                min_area: formData.get('min_area'),
                cooldown: formData.get('cooldown')
            };

            try {
                const response = await fetch('/api/save_motion_config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('Settings saved successfully!');
                } else {
                    alert('Failed to save settings: ' + result.error);
                }
            } catch (error) {
                alert('Error saving settings: ' + error);
            }
        };

        // Initialize
        draw();
        updateZoneList();
    </script>
</body>
</html>